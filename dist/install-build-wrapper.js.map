{"version":3,"file":"install-build-wrapper.js","sources":["../src/install-build-wrapper/utils.js","../src/install-build-wrapper/install-build-wrapper.js"],"sourcesContent":["import * as exec from \"@actions/exec\";\nimport * as path from \"path\";\n\n/**\n * Compute all names and paths related to the build wrapper\n * based on the runner environment\n */\nexport function getBuildWrapperInfo({\n  runnerOS,\n  runnerArch,\n  runnerTemp,\n  sonarHostUrl,\n}) {\n  const { buildWrapperSuffix, buildWrapperName } = getSuffixAndName(\n    runnerOS,\n    runnerArch\n  );\n\n  const buildWrapperDir = `${runnerTemp}/build-wrapper-${buildWrapperSuffix}`;\n  const buildWrapperUrl = `${sonarHostUrl}/static/cpp/build-wrapper-${buildWrapperSuffix}.zip`;\n  const buildWrapperBin = `${buildWrapperDir}/${buildWrapperName}`;\n\n  return {\n    buildWrapperUrl,\n    buildWrapperDir,\n    buildWrapperBin,\n  };\n}\n\nfunction getSuffixAndName(runnerOS, runnerArch) {\n  if (\n    runnerArch !== \"X64\" &&\n    !(runnerArch === \"ARM64\" && (runnerOS === \"macOS\" || runnerOS === \"Linux\"))\n  ) {\n    throw new Error(\n      `Architecture '${runnerArch}' is unsupported by build-wrapper`\n    );\n  }\n\n  switch (runnerOS) {\n    case \"Windows\":\n      return {\n        buildWrapperSuffix: \"win-x86\",\n        buildWrapperName: \"build-wrapper-win-x86-64.exe\",\n      };\n\n    case \"Linux\":\n      switch (runnerArch) {\n        case \"X64\":\n          return {\n            buildWrapperSuffix: \"linux-x86\",\n            buildWrapperName: \"build-wrapper-linux-x86-64\",\n          };\n\n        case \"ARM64\":\n          return {\n            buildWrapperSuffix: \"linux-aarch64\",\n            buildWrapperName: \"build-wrapper-linux-aarch64\",\n          };\n      }\n      break; // handled before the switch\n\n    case \"macOS\":\n      return {\n        buildWrapperSuffix: \"macosx-x86\",\n        buildWrapperName: \"build-wrapper-macosx-x86\",\n      };\n\n    default:\n      throw new Error(`Unsupported runner OS '${runnerOS}'`);\n  }\n}\n\nexport async function getRealPath(filePath, runnerOS) {\n  switch (runnerOS) {\n    case \"Windows\": {\n      const windowsResult = await exec.getExecOutput(\"cygpath\", [\n        \"--absolute\",\n        \"--windows\",\n        filePath,\n      ]);\n      return windowsResult.stdout.trim();\n    }\n    case \"Linux\": {\n      const linuxResult = await exec.getExecOutput(\"readlink\", [\n        \"-f\",\n        filePath,\n      ]);\n      return linuxResult.stdout.trim();\n    }\n    case \"macOS\": {\n      const macResult = await exec.getExecOutput(\"greadlink\", [\"-f\", filePath]);\n      return macResult.stdout.trim();\n    }\n    default:\n      return path.resolve(filePath);\n  }\n}\n","import * as core from \"@actions/core\";\nimport * as exec from \"@actions/exec\";\nimport * as fs from \"fs\";\nimport * as path from \"path\";\nimport { getBuildWrapperInfo, getRealPath } from \"./utils\";\n\nasync function installMacOSPackages() {\n  if (process.platform === \"darwin\") {\n    core.info(\"Installing required packages for macOS\");\n    await exec.exec(\"brew\", [\"install\", \"coreutils\"]);\n  }\n}\n\n/**\n * These RUNNER_XX env variables come from GitHub by default.\n * See https://docs.github.com/en/actions/reference/workflows-and-actions/variables#default-environment-variables\n *\n * If SONAR_HOST_URL is omitted, we assume sonarcloud.io\n */\nfunction getEnvVariables() {\n  const sonarHostUrl = process.env.SONAR_HOST_URL\n    ? process.env.SONAR_HOST_URL.replace(/\\/$/, \"\")\n    : \"https://sonarcloud.io\";\n\n  return {\n    runnerOS: process.env.RUNNER_OS,\n    runnerArch: process.env.RUNNER_ARCH,\n    runnerTemp: process.env.RUNNER_TEMP,\n    sonarHostUrl,\n  };\n}\n\nasync function downloadAndInstallBuildWrapper(downloadUrl, runnerEnv) {\n  const { runnerArch, runnerOS, runnerTemp } = runnerEnv;\n  const tmpZipPath = path.join(\n    runnerTemp,\n    `build-wrapper-${runnerOS}-${runnerArch}.zip`\n  );\n\n  core.startGroup(`Download ${downloadUrl}`);\n\n  core.info(`Downloading '${downloadUrl}'`);\n\n  if (!fs.existsSync(runnerTemp)) {\n    fs.mkdirSync(runnerTemp, { recursive: true });\n  }\n\n  await exec.exec(\"curl\", [\"-sSLo\", tmpZipPath, downloadUrl]);\n\n  core.info(\"Decompressing\");\n  await exec.exec(\"unzip\", [\"-o\", \"-d\", runnerTemp, tmpZipPath]);\n\n  core.endGroup();\n}\n\nasync function run() {\n  try {\n    await installMacOSPackages();\n\n    const envVariables = getEnvVariables();\n\n    const { buildWrapperBin, buildWrapperDir, buildWrapperUrl } =\n      getBuildWrapperInfo(envVariables);\n\n    await downloadAndInstallBuildWrapper(buildWrapperUrl, envVariables);\n\n    const buildWrapperBinDir = await getRealPath(\n      buildWrapperDir,\n      envVariables.runnerOS\n    );\n    core.addPath(buildWrapperBinDir);\n    core.info(`'${buildWrapperBinDir}' added to the path`);\n\n    const buildWrapperBinPath = await getRealPath(\n      buildWrapperBin,\n      envVariables.runnerOS\n    );\n    core.setOutput(\"build-wrapper-binary\", buildWrapperBinPath);\n    core.info(`'build-wrapper-binary' output set to '${buildWrapperBinPath}'`);\n  } catch (error) {\n    core.setFailed(error.message);\n  }\n}\n\nrun();\n"],"names":["exec.getExecOutput","core.info","exec.exec","core.startGroup","core.endGroup","core.addPath","core.setOutput","core.setFailed"],"mappings":"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"}