{"version":3,"file":"install-build-wrapper.js","sources":["../src/install-build-wrapper/utils.js","../src/install-build-wrapper/install-build-wrapper.js"],"sourcesContent":["import * as exec from \"@actions/exec\";\r\nimport * as path from \"path\";\r\n\r\n/**\r\n * Compute all names and paths related to the build wrapper\r\n * based on the runner environment\r\n */\r\nexport function getBuildWrapperInfo({\r\n  runnerOS,\r\n  runnerArch,\r\n  runnerTemp,\r\n  sonarHostUrl,\r\n}) {\r\n  const { buildWrapperSuffix, buildWrapperName } = getSuffixAndName(\r\n    runnerOS,\r\n    runnerArch\r\n  );\r\n\r\n  const buildWrapperDir = `${runnerTemp}/build-wrapper-${buildWrapperSuffix}`;\r\n  const buildWrapperUrl = `${sonarHostUrl}/static/cpp/build-wrapper-${buildWrapperSuffix}.zip`;\r\n  const buildWrapperBin = `${buildWrapperDir}/${buildWrapperName}`;\r\n\r\n  return {\r\n    buildWrapperUrl,\r\n    buildWrapperDir,\r\n    buildWrapperBin,\r\n  };\r\n}\r\n\r\nfunction getSuffixAndName(runnerOS, runnerArch) {\r\n  if (\r\n    runnerArch !== \"X64\" &&\r\n    !(runnerArch === \"ARM64\" && (runnerOS === \"macOS\" || runnerOS === \"Linux\"))\r\n  ) {\r\n    throw new Error(\r\n      `Architecture '${runnerArch}' is unsupported by build-wrapper`\r\n    );\r\n  }\r\n\r\n  switch (runnerOS) {\r\n    case \"Windows\":\r\n      return {\r\n        buildWrapperSuffix: \"win-x86\",\r\n        buildWrapperName: \"build-wrapper-win-x86-64.exe\",\r\n      };\r\n\r\n    case \"Linux\":\r\n      switch (runnerArch) {\r\n        case \"X64\":\r\n          return {\r\n            buildWrapperSuffix: \"linux-x86\",\r\n            buildWrapperName: \"build-wrapper-linux-x86-64\",\r\n          };\r\n\r\n        case \"ARM64\":\r\n          return {\r\n            buildWrapperSuffix: \"linux-aarch64\",\r\n            buildWrapperName: \"build-wrapper-linux-aarch64\",\r\n          };\r\n      }\r\n      break; // handled before the switch\r\n\r\n    case \"macOS\":\r\n      return {\r\n        buildWrapperSuffix: \"macosx-x86\",\r\n        buildWrapperName: \"build-wrapper-macosx-x86\",\r\n      };\r\n\r\n    default:\r\n      throw new Error(`Unsupported runner OS '${runnerOS}'`);\r\n  }\r\n}\r\n\r\nexport async function getRealPath(filePath, runnerOS) {\r\n  switch (runnerOS) {\r\n    case \"Windows\": {\r\n      const windowsResult = await exec.getExecOutput(\"cygpath\", [\r\n        \"--absolute\",\r\n        \"--windows\",\r\n        filePath,\r\n      ]);\r\n      return windowsResult.stdout.trim();\r\n    }\r\n    case \"Linux\": {\r\n      const linuxResult = await exec.getExecOutput(\"readlink\", [\r\n        \"-f\",\r\n        filePath,\r\n      ]);\r\n      return linuxResult.stdout.trim();\r\n    }\r\n    case \"macOS\": {\r\n      const macResult = await exec.getExecOutput(\"greadlink\", [\"-f\", filePath]);\r\n      return macResult.stdout.trim();\r\n    }\r\n    default:\r\n      return path.resolve(filePath);\r\n  }\r\n}\r\n","import * as core from \"@actions/core\";\r\nimport * as exec from \"@actions/exec\";\r\nimport * as fs from \"fs\";\r\nimport * as path from \"path\";\r\nimport { getBuildWrapperInfo, getRealPath } from \"./utils\";\r\n\r\nasync function installMacOSPackages() {\r\n  if (process.platform === \"darwin\") {\r\n    core.info(\"Installing required packages for macOS\");\r\n    await exec.exec(\"brew\", [\"install\", \"coreutils\"]);\r\n  }\r\n}\r\n\r\n/**\r\n * These RUNNER_XX env variables come from GitHub by default.\r\n * See https://docs.github.com/en/actions/reference/workflows-and-actions/variables#default-environment-variables\r\n *\r\n * If SONAR_HOST_URL is omitted, we assume sonarcloud.io\r\n */\r\nfunction getEnvVariables() {\r\n  const sonarHostUrl = process.env.SONAR_HOST_URL\r\n    ? process.env.SONAR_HOST_URL.replace(/\\/$/, \"\")\r\n    : \"https://sonarcloud.io\";\r\n\r\n  return {\r\n    runnerOS: process.env.RUNNER_OS,\r\n    runnerArch: process.env.RUNNER_ARCH,\r\n    runnerTemp: process.env.RUNNER_TEMP,\r\n    sonarHostUrl,\r\n  };\r\n}\r\n\r\nasync function downloadAndInstallBuildWrapper(downloadUrl, runnerEnv) {\r\n  const { runnerArch, runnerOS, runnerTemp } = runnerEnv;\r\n  const tmpZipPath = path.join(\r\n    runnerTemp,\r\n    `build-wrapper-${runnerOS}-${runnerArch}.zip`\r\n  );\r\n\r\n  core.startGroup(`Download ${downloadUrl}`);\r\n\r\n  core.info(`Downloading '${downloadUrl}'`);\r\n\r\n  if (!fs.existsSync(runnerTemp)) {\r\n    fs.mkdirSync(runnerTemp, { recursive: true });\r\n  }\r\n\r\n  await exec.exec(\"curl\", [\"-sSLo\", tmpZipPath, downloadUrl]);\r\n\r\n  core.info(\"Decompressing\");\r\n  await exec.exec(\"unzip\", [\"-o\", \"-d\", runnerTemp, tmpZipPath]);\r\n\r\n  core.endGroup();\r\n}\r\n\r\nasync function run() {\r\n  try {\r\n    await installMacOSPackages();\r\n\r\n    const envVariables = getEnvVariables();\r\n\r\n    const { buildWrapperBin, buildWrapperDir, buildWrapperUrl } =\r\n      getBuildWrapperInfo(envVariables);\r\n\r\n    await downloadAndInstallBuildWrapper(buildWrapperUrl, envVariables);\r\n\r\n    const buildWrapperBinDir = await getRealPath(\r\n      buildWrapperDir,\r\n      envVariables.runnerOS\r\n    );\r\n    core.addPath(buildWrapperBinDir);\r\n    core.info(`'${buildWrapperBinDir}' added to the path`);\r\n\r\n    const buildWrapperBinPath = await getRealPath(\r\n      buildWrapperBin,\r\n      envVariables.runnerOS\r\n    );\r\n    core.setOutput(\"build-wrapper-binary\", buildWrapperBinPath);\r\n    core.info(`'build-wrapper-binary' output set to '${buildWrapperBinPath}'`);\r\n  } catch (error) {\r\n    core.setFailed(error.message);\r\n  }\r\n}\r\n\r\nrun();\r\n"],"names":["exec.getExecOutput","core.info","exec.exec","core.startGroup","core.endGroup","core.addPath","core.setOutput","core.setFailed"],"mappings":"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"}